-- Создаём таблицу шаблонов матриц (системные + пользовательские)
CREATE TABLE IF NOT EXISTS matrix_templates (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    is_system BOOLEAN DEFAULT FALSE,
    organization_id INTEGER REFERENCES organizations(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Создаём таблицу критериев шаблонов
CREATE TABLE IF NOT EXISTS template_criteria (
    id SERIAL PRIMARY KEY,
    template_id INTEGER REFERENCES matrix_templates(id),
    axis VARCHAR(20) NOT NULL CHECK (axis IN ('x', 'y', 'universal')),
    name VARCHAR(255) NOT NULL,
    weight REAL DEFAULT 1.0,
    min_value REAL DEFAULT 0,
    max_value REAL DEFAULT 10,
    hint TEXT,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Создаём таблицу оценок клиентов по критериям
CREATE TABLE IF NOT EXISTS client_criterion_scores (
    id SERIAL PRIMARY KEY,
    client_id INTEGER REFERENCES clients(id),
    criterion_id INTEGER REFERENCES matrix_criteria(id),
    score REAL NOT NULL DEFAULT 0,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(client_id, criterion_id)
);

-- Добавляем template_id в таблицу matrices
ALTER TABLE matrices ADD COLUMN IF NOT EXISTS template_id INTEGER REFERENCES matrix_templates(id);

-- Создаём индексы для производительности
CREATE INDEX IF NOT EXISTS idx_template_criteria_template ON template_criteria(template_id);
CREATE INDEX IF NOT EXISTS idx_template_criteria_axis ON template_criteria(axis);
CREATE INDEX IF NOT EXISTS idx_client_scores_client ON client_criterion_scores(client_id);
CREATE INDEX IF NOT EXISTS idx_client_scores_criterion ON client_criterion_scores(criterion_id);
CREATE INDEX IF NOT EXISTS idx_matrices_template ON matrices(template_id);

-- Вставляем 4 системных шаблона
INSERT INTO matrix_templates (name, description, is_system, organization_id) VALUES
('Продажи ИИ-продуктов', 'Матрица для оценки потенциала внедрения ИИ-решений и бизнес-привлекательности клиентов', TRUE, NULL),
('Сложное техническое оборудование', 'Матрица для оценки готовности к покупке и экономической выгоды при продаже оборудования', TRUE, NULL),
('Корпоративное ПО', 'Матрица для оценки технической совместимости и бизнес-ценности при внедрении ПО', TRUE, NULL),
('Консалтинг', 'Матрица для оценки готовности к изменениям и коммерческого потенциала консалтинговых проектов', TRUE, NULL);

-- Заполняем критерии для шаблона 1: Продажи ИИ-продуктов
INSERT INTO template_criteria (template_id, axis, name, weight, min_value, max_value, hint, sort_order) VALUES
-- Ось X: Потенциал внедрения ИИ
(1, 'x', 'Цифровая инфраструктура', 3, 0, 5, '0=нет систем, 3=МИС, 5=МИС+РИС+PACS+API', 1),
(1, 'x', 'Качество данных', 2, 0, 5, '0=не структурированы, 3=частично, 5=размечены', 2),
(1, 'x', 'Техническая зрелость', 2, 0, 5, '0=нет IT, 3=подрядчик, 5=свой IT+аналитики', 3),
(1, 'x', 'Готовность к экспериментам', 2, 0, 3, '0=консервативны, 2=готовы к пилоту, 3=активно тестируют', 4),
(1, 'x', 'Регуляторные ограничения', 1, 0, 2, '0=жесткие, 1=умеренные, 2=минимальные', 5),
-- Ось Y: Бизнес-привлекательность
(1, 'y', 'Годовой бюджет на инновации', 4, 0, 5, '0=<1млн, 3=1-5млн, 5=>5млн', 1),
(1, 'y', 'Масштаб применения', 2, 0, 3, '0=1 отдел, 2=несколько, 3=корпоративный', 2),
(1, 'y', 'Срочность задачи', 2, 0, 3, '0=нет боли, 2=есть проблема, 3=критическая боль', 3),
(1, 'y', 'Лояльность к поставщику', 1, 0, 2, '0=новый, 1=работали, 2=стратег.партнер', 4),
(1, 'y', 'Референсный потенциал', 1, 0, 2, '0=низкий, 1=средний, 2=отраслевой лидер', 5),
-- Универсальный параметр
(1, 'universal', 'Зрелость потребности', 1, 0, 10, 'Насколько клиент осознаёт потребность в решении (0=не осознаёт, 10=критическая необходимость)', 1);

-- Заполняем критерии для шаблона 2: Сложное оборудование
INSERT INTO template_criteria (template_id, axis, name, weight, min_value, max_value, hint, sort_order) VALUES
-- Ось X: Готовность к покупке
(2, 'x', 'Финансирование проекта', 4, 0, 3, '0=не утверждено, 2=согласование, 3=выделен бюджет', 1),
(2, 'x', 'Инфраструктурная готовность', 3, 0, 3, '0=нужна реконструкция, 2=частично, 3=готово', 2),
(2, 'x', 'Срок замены оборудования', 2, 0, 5, '0=>5лет, 3=2-5лет, 5=<2года/аварийное', 3),
(2, 'x', 'Техническая экспертиза', 1, 0, 2, '0=нет спец-в, 1=базовые, 2=сертиф.', 4),
(2, 'x', 'Конкурентная ситуация', 2, 0, 3, '0=выбран конкурент, 2=рассматривают, 3=фавориты', 5),
-- Ось Y: Экономическая выгода
(2, 'y', 'Стоимость жизненного цикла', 3, 0, 5, '0=низкая экономия, 3=10-20%, 5=>20%', 1),
(2, 'y', 'Объем закупки', 4, 0, 5, '0=1 единица, 3=2-5шт, 5=>5шт/фрейм', 2),
(2, 'y', 'Дополнительные сервисы', 1, 0, 3, '0=гарантия, 2=+ТО, 3=+обучение+апгрейды', 3),
(2, 'y', 'Стратегическая важность', 1, 0, 3, '0=вспомогат., 2=важное, 3=критическое', 4),
(2, 'y', 'Референсная ценность', 1, 0, 2, '0=региональный, 1=отраслевой, 2=флагманский', 5),
-- Универсальный параметр
(2, 'universal', 'Зрелость потребности', 1, 0, 10, 'Насколько клиент осознаёт потребность в решении', 1);

-- Заполняем критерии для шаблона 3: Корпоративное ПО
INSERT INTO template_criteria (template_id, axis, name, weight, min_value, max_value, hint, sort_order) VALUES
-- Ось X: Техническая совместимость
(3, 'x', 'Интеграционная зрелость', 3, 0, 5, '0=закрытые системы, 3=частич.интеграция, 5=API', 1),
(3, 'x', 'Масштаб внедрения', 3, 0, 5, '0=<10 польз., 3=10-100, 5=>100/мультифилиал', 2),
(3, 'x', 'Готовность данных', 2, 0, 3, '0="грязные", 2=частич.очистка, 3=чистые+процессы', 3),
(3, 'x', 'ИТ-команда', 1, 0, 3, '0=нет ресурсов, 2=1-2чел, 3=команда+архитектор', 4),
(3, 'x', 'Стандарты безопасности', 1, 0, 2, '0=базовые, 1=отраслевые, 2=сертифицировано', 5),
-- Ось Y: Бизнес-ценность
(3, 'y', 'Рентабельность проекта', 3, 0, 5, '0=<1года, 3=1-2года, 5=>2лет/стратегич.', 1),
(3, 'y', 'Поддержка топ-менеджмента', 2, 0, 3, '0=средний мен., 2=замдиректора, 3=CEO/совет', 2),
(3, 'y', 'Конкурентное давление', 2, 0, 3, '0=нет, 2=есть альтернативы, 3=критич.необходимость', 3),
(3, 'y', 'Модель лицензирования', 2, 0, 3, '0=бессрочная, 2=подписка 1-3г, 3=многоур+кастом', 4),
(3, 'y', 'Потенциал кросс-продаж', 1, 0, 2, '0=нет, 1=1-2 модуля, 2=экосистема', 5),
-- Универсальный параметр
(3, 'universal', 'Зрелость потребности', 1, 0, 10, 'Насколько клиент осознаёт потребность в решении', 1);

-- Заполняем критерии для шаблона 4: Консалтинг
INSERT INTO template_criteria (template_id, axis, name, weight, min_value, max_value, hint, sort_order) VALUES
-- Ось X: Готовность к изменениям
(4, 'x', 'Осознание проблемы', 3, 0, 5, '0=не признают, 3=признают, 5=сформулирована+метрики', 1),
(4, 'x', 'Культура изменений', 2, 0, 3, '0=консервативная, 2=открытая, 3=инновационная', 2),
(4, 'x', 'Ресурсы на внедрение', 2, 0, 3, '0=нет, 2=частично, 3=команда+полномочия', 3),
(4, 'x', 'Сроки реализации', 2, 0, 3, '0=гибкие, 2=6-12мес, 3=<6мес/дедлайн', 4),
(4, 'x', 'Предыдущий опыт', 1, 0, 2, '0=нет опыта, 1=неудачи, 2=успешные трансформации', 5),
-- Ось Y: Коммерческий потенциал
(4, 'y', 'Бюджет на консалтинг', 4, 0, 5, '0=<500т, 3=500т-3млн, 5=>3млн', 1),
(4, 'y', 'Масштаб влияния', 2, 0, 3, '0=1 процесс, 2=несколько подразд., 3=корпор.трансф.', 2),
(4, 'y', 'Повторные продажи', 2, 0, 3, '0=разовый, 2=1-2 итерации, 3=партнерство 3+года', 3),
(4, 'y', 'Референсная ценность', 1, 0, 2, '0=низкая узнаваемость, 1=отраслевой, 2=медиа-лидер', 4),
(4, 'y', 'Дополнительные услуги', 1, 0, 3, '0=только консалтинг, 2=+обучение, 3=+ПО+аутсорсинг', 5),
-- Универсальный параметр
(4, 'universal', 'Зрелость потребности', 1, 0, 10, 'Насколько клиент осознаёт потребность в решении', 1);